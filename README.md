# Тонкая синхронизация двоичного дерева

## Алгоритм

Чтобы захватить лок корня дерева, необходимо предварительно захватить глобальный лок дерева. Это необходимо
для того, чтобы не возникало ситуаций, когда кто-то ожидает освобождения корня дерева, а корень уже удален.

В каждой операции захватываем лок на корень и проверяем краевые случаи, например для удаления - случай когда удаляемая вершина - корень дерева и не имеет правого сына.

##### Поиск 
Итерируемся вглубь дерева с помощью hand-over-hand блокировки: то есть захватываем лок вершины x, затем захватываем лок ее ребенка, освобождаем лок x.

##### Добавление
Производим поиск вершины, но в конце не освобождаем лок на вершину (если таковая присутствует в дереве) и на ее родителя. Затем производим добавления в нужное место и освобождаем локи. (Если в дереве уже существует вершина с добавляемым ключом, то просто заменяется значение)

##### Удаление
Если у удалемой вершины нет правого сына, то удаляем ее, перекинув указатель с ее родителя на ее сына.
Если у удалемой вершины есть правый сын, то делаем поиск преемника (самая левая вершина в правом поддереве), затем изменяем значения key, value на значения преемника и удаляем преемника как в предыдущем случае.
